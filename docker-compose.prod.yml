# =============================================================================
# Production Docker Compose Override - AttaqwaMasjid LMS
# =============================================================================
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# Adds: Caddy reverse proxy, Redis, network isolation, resource limits,
#        log rotation, security hardening, graceful shutdown timeouts.
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Caddy - Reverse Proxy with auto-TLS
  # ---------------------------------------------------------------------------
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "${CADDY_HTTP_PORT:-80}:80"
      - "${CADDY_HTTPS_PORT:-443}:443"
      - "${CADDY_HTTPS_PORT:-443}:443/udp"  # HTTP/3
    environment:
      DOMAIN: ${DOMAIN:-localhost}
    volumes:
      - ./docker/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - frontend
      - backend
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          memory: 64M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/caddy-health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  # Redis - Caching and rate limiting
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: >
      redis-server
      --maxmemory ${REDIS_MAXMEMORY:-256mb}
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --requirepass ${REDIS_PASSWORD:-change-this-redis-password}
    volumes:
      - redis_data:/data
    networks:
      - database
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-change-this-redis-password}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------------------------------
  # PostgreSQL - Override with production hardening
  # ---------------------------------------------------------------------------
  postgres:
    networks:
      - database
    ports: !override []  # Remove host port exposure in production
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "5"
    security_opt:
      - no-new-privileges:true

  # ---------------------------------------------------------------------------
  # API (Strapi) - Override with production settings
  # ---------------------------------------------------------------------------
  api:
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-change-this-redis-password}
    ports: !override []  # Only accessible via Caddy
    networks:
      - backend
      - database
    depends_on:
      postgres:
        condition: service_healthy
      ollama:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          memory: 512M
    stop_grace_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "5"
    security_opt:
      - no-new-privileges:true

  # ---------------------------------------------------------------------------
  # Admin Portal - Override with production settings
  # ---------------------------------------------------------------------------
  admin:
    ports: !override []  # Only accessible via Caddy
    networks:
      - frontend
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1G
        reservations:
          memory: 256M
    stop_grace_period: 15s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

  # ---------------------------------------------------------------------------
  # Website - Override with production settings
  # ---------------------------------------------------------------------------
  website:
    ports: !override []  # Only accessible via Caddy
    networks:
      - frontend
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1G
        reservations:
          memory: 256M
    stop_grace_period: 15s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

  # ---------------------------------------------------------------------------
  # Ollama - Override with production resource limits
  # ---------------------------------------------------------------------------
  ollama:
    ports: !override []  # Internal only
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: "4"
          memory: 8G
        reservations:
          memory: 2G
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

# =============================================================================
# Networks - Three-tier isolation
# =============================================================================
networks:
  frontend:
    driver: bridge
    name: attaqwa-frontend
  backend:
    driver: bridge
    name: attaqwa-backend
    internal: false  # Needs outbound for Ollama model pulls
  database:
    driver: bridge
    name: attaqwa-database
    internal: true  # No external access

# =============================================================================
# Additional Volumes
# =============================================================================
volumes:
  caddy_data:
    driver: local
  caddy_config:
    driver: local
  redis_data:
    driver: local
